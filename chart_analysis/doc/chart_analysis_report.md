# 谱面可视化分析模块实现报告

## 一、概述

谱面可视化分析模块是 MuseDash 项目的重要组成部分，旨在对游戏谱面进行全面的统计分析与可视化展示。该模块能够自动扫描项目中的谱面目录，解析谱面文件，提取关键信息，并生成多种类型的统计图表和数据摘要，为谱面设计、难度评估和数据分析提供有力支持。

## 二、系统架构设计

### 2.1 模块结构

谱面分析模块采用模块化设计，主要包含以下组件：主程序 `chart_analysis.py` 负责整体流程控制，依赖管理文件 `requirements.txt` 确保运行环境的一致性，输出目录 `outputs/` 存储所有生成的分析结果，包括协议文件、统计摘要和可视化图表。

### 2.2 核心类设计

系统采用面向对象的设计思想，将功能划分为三个核心类。ChartParser（谱面解析器）负责读取和解析谱面 TXT 文件，从文件第一行提取 BPM 信息，逐行解析音符事件，并计算谱面总时长。ChartAnalyzer（谱面分析器）对解析后的数据进行多维度统计分析，包括总音符数统计、类型分布统计、密度曲线计算、轨道分布统计、时间分布数据提取以及难度曲线计算。ChartVisualizer（谱面可视化器）负责将统计数据转化为直观的可视化图表，生成六种不同类型的图表文件。

## 三、实现流程

### 3.1 谱面解析流程

系统首先扫描 `charts/` 目录下的所有谱面子目录，对每个谱面目录进行以下处理：检查谱面 TXT 文件是否存在，调用 `chart_check()` 函数进行格式校验，使用 ChartParser 解析谱面文件。解析过程中，系统读取文件第一行提取 BPM 值，使用正则表达式逐行匹配音符事件格式 `(时间,类型,轨道)`，将所有音符记录到列表中，并计算最大时间作为谱面时长。解析完成后，系统将 BPM、音符列表和时长信息传递给分析器。

### 3.2 统计分析流程

ChartAnalyzer 接收解析后的数据，执行全面的统计分析。在总音符数统计方面，系统只统计 `tap` 和 `hold_start` 类型的音符，避免 `hold_mid` 音符的重复计算，确保统计结果的准确性。类型分布统计记录每种音符类型的数量，为后续的可视化提供数据基础。

密度曲线计算采用时间窗口方法，将谱面时长划分为多个时间窗口，窗口大小根据谱面总时长动态调整（`max(100, duration/100)`），然后统计每个窗口内的音符数量，生成时间-密度映射关系。这种方法能够有效反映谱面在不同时间段的音符密度变化。

轨道分布统计记录每个轨道上的音符数量，帮助分析谱面的轨道使用情况。时间分布数据提取所有 tap 和 hold_start 音符的时间点，为生成时间分布直方图提供原始数据。

难度曲线计算是系统的核心功能之一，综合考虑多个因素。首先，系统为不同音符类型赋予权重：tap 音符权重为 1.0，hold_start 权重为 1.5，hold_mid 权重为 0.3，hold_end 权重为 0.5。其次，考虑轨道复杂度，当多个轨道同时出现音符时，难度会相应增加，计算公式为 `1.0 + 0.2 * (轨道数 - 1)`。再次，考虑密度因子，音符越多，难度增长越快，采用非线性增长公式 `1.0 + 0.1 * (音符数 - 1)`。最终难度分数为加权和乘以轨道复杂度再乘以密度因子，生成时间-难度分数映射，用于绘制难度曲线。

### 3.3 可视化生成流程

ChartVisualizer 根据分析结果生成六种不同类型的可视化图表。音符类型数量饼图展示各类型音符的绝对数量，使用自定义格式化函数显示实际数字而非百分比，采用渐变色配色方案，添加阴影和扇形分离效果，提高视觉区分度。音符类型占比饼图则展示各类型音符的相对比例，显示百分比数值，同样采用优化的视觉样式。

密度曲线图使用折线图和填充区域展示谱面随时间变化的音符密度，添加网格线便于读取数值，优化样式提高可读性。轨道分布柱状图展示每个轨道的音符数量，使用渐变色柱状图，在柱状图上直接显示数值标签，添加网格线辅助读取。

音符时间分布直方图展示音符在时间轴上的分布情况，使用渐变色直方图，根据谱面时长动态调整 bins 数量，帮助识别谱面的时间分布特征。难度曲线分析图展示谱面随时间变化的难度分数，综合考虑密度、音符类型复杂度和轨道分布，显示平均难度线和峰值标记，添加峰值标注帮助识别最难点。

所有图表均采用 200 DPI 的高分辨率输出，确保打印和显示质量。图表使用现代配色方案，包括红色、青色、蓝色等渐变色，优化字体大小和粗细，提高可读性。饼图添加阴影效果增强立体感，曲线图和柱状图添加网格线便于数值读取。

### 3.4 数据输出流程

系统生成两种主要的数据输出文件。summary.json 文件包含谱面的核心统计信息，包括曲目名、BPM 值、谱面时长、总音符数、tap 音符数量、hold_start 音符数量、各类型音符数量分布、轨道分布、密度峰值和平均密度。为了减小文件大小，密度曲线数据、难度曲线数据和时间分布数据不包含在 summary.json 中，这些信息可以通过对应的图表文件查看。

protocol.json 文件作为协议文件，汇总所有谱面的信息，包括每个谱面的名称、生成的图表文件列表、summary 文件路径，以及可选的 BPM、时长、文件夹名和音频文件名。该文件便于前端系统读取和展示分析结果。

## 四、技术实现细节

### 4.1 依赖库选择

系统使用 matplotlib 作为主要的图表生成库，该库功能强大，支持多种图表类型，输出质量高。numpy 用于数值计算和颜色生成，提供高效的数组操作和数学运算支持。Python 标准库中的 json 模块用于 JSON 文件的读写，pathlib 用于跨平台的路径处理，re 模块用于正则表达式解析谱面文件格式。

### 4.2 谱面文件格式解析

谱面文件采用简单的文本格式，第一行为 BPM 信息，格式为 `bpm=数值`。后续每行表示一个音符事件，格式为 `(时间,类型,轨道)`，其中时间为整数，类型包括 tap、hold_start、hold_mid、hold_end 等，轨道为 0 或 1。系统使用正则表达式精确匹配这种格式，确保解析的准确性。

### 4.3 图表尺寸适配

为了适配前端显示需求，系统对不同类型的图表采用不同的尺寸策略。饼图使用 6x6 英寸的正方形尺寸，确保圆形饼图完整显示，不使用 `bbox_inches='tight'` 参数以保持固定比例。其他图表（曲线图、柱状图、直方图）统一使用 9x6 英寸的 3:2 比例，与前端容器的 180x120 像素比例匹配，确保图表在前端完整显示而不被裁剪。

### 4.4 特殊处理机制

系统对 Random 谱面采用与其他谱面相同的处理逻辑，无需特殊区分，保证了处理的一致性。在统计总音符数时，系统不计算 hold_mid 音符，避免重复计数，确保统计结果的准确性。对于空数据情况，系统会生成空图表占位，避免程序异常。系统明确区分 note_count 和 note_density 两种饼图，前者显示实际数量（整数），后者显示百分比（相对比例），满足不同的分析需求。

## 五、使用方式

### 5.1 环境配置

使用前需要安装必要的依赖库，执行 `pip install -r requirements.txt` 命令即可完成环境配置。系统要求 Python 3.6 及以上版本。

### 5.2 运行分析

在 chart_analysis 目录下执行 `python chart_analysis.py` 命令，系统会自动扫描 charts 目录下的所有谱面，进行解析、分析和可视化生成。处理完成后，所有输出文件保存在 `chart_analysis/outputs/` 目录中。

### 5.3 输出文件说明

输出目录包含以下文件：protocol.json 协议文件列出所有谱面的文件清单，每个谱面对应一个 summary.json 文件包含统计摘要，以及六种类型的 PNG 图表文件，包括音符类型数量饼图、音符类型占比饼图、密度曲线图、轨道分布柱状图、时间分布直方图和难度曲线分析图。

## 六、前端集成

系统设计充分考虑了前端集成的便利性。前端可以通过读取 protocol.json 文件获取所有谱面的信息列表，然后根据文件列表加载对应的图表和统计摘要。图表文件采用标准 PNG 格式，可以直接在 HTML 中使用 img 标签显示。统计摘要采用 JSON 格式，便于 JavaScript 解析和展示。

## 七、功能总结

当前版本已实现完整的谱面分析功能，包括自动扫描和解析谱面目录、多维度统计分析（总音符数、类型分布、密度曲线、轨道分布、时间分布、难度曲线）、六种类型的可视化图表生成、样式优化和高质量输出，以及自动生成协议文件便于前端集成。系统设计合理，功能完善，能够满足谱面分析和可视化的需求。

## 八、未来扩展方向

系统具有良好的扩展性，未来可以考虑以下功能增强：如果谱面支持多 BPM，可以绘制 BPM 变化曲线；使用 plotly 生成可交互的 HTML 图表，提供更好的用户体验；支持多个谱面的对比分析；添加更多统计指标，如连击数、最大连击、平均间隔等；生成热力图，展示音符在时间和轨道上的热力分布，提供更直观的分析视角。

